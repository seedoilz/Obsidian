---
aliases: 
tags:
  - code/concurrent
title: 多线程挑战
date created: 2025-04-15 19:04:00
date modified: 2025-04-15 20:04:15
notion_url: https://www.notion.so/seedoilz/1-6w-Java-AQS-ReentrantLock-Condition-51CTO-COM-1d555ad69c3a81c0ac36d593c7a439bc?pvs=4
---
## 上下文切换
上下文切换前保存上一个任务的状态，以便下次切换回这个任务时，可以再加载这 个任务的状态。所以任务从保存到再加载的过程就是一次上下文切换。

这就像我们同时读两本书，当我们在读一本英文的技术书时，发现某个单词不认识，于是 便打开中英文字典，但是在放下英文技术书之前，大脑必须先记住这本书读到了多少页的第 多少行，等查完单词之后，能够继续读这本书。

### 上下文切换的开销
线程上下文切换是有成本的，主要体现在以下几个方面：
- CPU 开销：保存和恢复线程状态需要 CPU 执行额外的指令
- 缓存失效：上下文切换可能导致 CPU 缓存、TLB（Translation Lookaside Buffer）和分支预测器的失效，从而增加内存访问延迟。
- 内核态开销：上下文切换通常涉及从用户态切换到内核态的操作，这进一步增加了开销。

如下图所示，保存上下文和恢复上下文的过程并不是 “免费” 的，需要内核在 CPU 上运行才能完成。
![](https://typora-tes.oss-cn-shanghai.aliyuncs.com/picgo/82fd9ee8017d45fbe7b537804b91ed9de941db.png)


> [!NOTE] 单核处理器也支持多线程执行代码吗？
> CPU 通过给每个线程分配 CPU 时间片来实现 这个机制。时间片是 CPU 分配给各个线程的时间，因为时间片非常短。
> 所以 CPU 通过不停地切换线程执行，让我们感觉多个线程是同时执行的，时间片一般是几十毫秒（ms）。

### 减少上下文切换的方法
- **减少线程数量**：使用合理数量的线程，避免线程过多导致频繁切换。
- **无锁编程**：减少线程之间的锁竞争，降低阻塞几率，如将数据的 ID 按照 Hash 算法取模分段，不同的线程处理不同段的数据。
- **使用适当的线程池**：利用线程池复用线程，避免频繁的线程创建和销毁。
- **CAS 算法**：Java 的 Atomic 包使用 CAS 算法来更新数据，而不需要加锁。
- **线程池复用**：选择合适的调度策略，减少不必要的上下文切换。

## 死锁
在 Java 中，死锁（Deadlock）情况是指：**两个或两个以上的线程持有不同系统资源的锁，线程彼此都等待获取对方的锁来完成自己的任务，但是没有让出自己持有的锁，线程就会无休止等待下去。**

线程竞争的资源可以是：**锁、网络连接、通知事件，磁盘、带宽，以及一切可以被称作 “资源” 的东西。**

![](https://typora-tes.oss-cn-shanghai.aliyuncs.com/picgo/18665c203b57111a9016228acca556b90c3079.png)

### 如何检测死锁
`JDK`自带了一些简单好用的工具，可以帮助我们检测死锁（如：`jstack`）。使用`jstack`侦测目标 JVM 进程.
```jsx
$ jstack $(jps -l | grep 'DeadLockExample' | cut -f1 -d ' ')
```

## 资源限制的挑战
### 什么是资源限制？
资源限制是指在进行并发编程时，程序的执行速度受限于计算机硬件资源或软件资源。

例如，服务器的带宽只有 2Mb/s，某个资源的下载速度是 1Mb/s 每秒，系统启动 10 个线程下载资 源，下载速度不会变成 10Mb/s，所以在进行并发编程时，要考虑这些资源的限制。

硬件资源限 制有带宽的上传 / 下载速度、硬盘读写速度和 CPU 的处理速度。
软件资源限制有数据库的连接数和 socket 连接数等。

### 资源限制会引发什么问题？
是如果将某段串行的代码并发执行，因为受限于资源，仍然在串行执行，这时候程序不仅不 会加快执行，反而会更慢，因为增加了上下文切换和资源调度的时间。

例如，之前看到一段程 序使用多线程在办公网并发地下载和处理数据时，导致 CPU 利用率达到 100%，几个小时都不 能运行完成任务，后来修改成单线程，一个小时就执行完成了。

### 如何在资源限制的情况下进行并发编程呢？
- 根据不同的资源限制调整 程序的并发度，比如下载文件程序依赖于两个资源——带宽和硬盘读写速度。
- 有数据库操作时，涉及数据库连接数，如果 SQL 语句执行非常快，而线程的数量比数据库连接数大很多，则 某些线程会被阻塞，等待数据库连接。